version: '3.8'

services:
  # Nginx 反向代理
  nginx:
    image: nginx:alpine
    container_name: soundscape-nginx
    restart: always
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/ssl:/etc/nginx/ssl:ro
      - ../../../frontend-web/dist:/var/www/html:ro
      - ../../logs/nginx:/var/log/nginx
    depends_on:
      - nodejs-server
      - python-server
    networks:
      - soundscape-network
    environment:
      TZ: Asia/Shanghai
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost/"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Node.js WebSocket 服务器
  nodejs-server:
    build:
      context: ../../backend-nodejs
      dockerfile: ../docker/Dockerfile.nodejs
    container_name: soundscape-nodejs
    restart: always
    ports:
      - "3000:3000"
    environment:
      NODE_ENV: production
      PORT: 3000
      FASTAPI_URL: http://python-server:8000
      FRONTEND_URL: http://localhost
      LOG_LEVEL: info
      TZ: Asia/Shanghai
    volumes:
      - ../../backend-nodejs/src:/app/src:ro
      - ../../logs/nodejs:/app/logs
    depends_on:
      - python-server
    networks:
      - soundscape-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Python FastAPI 服务器
  python-server:
    build:
      context: ../../backend-ai
      dockerfile: ../docker/Dockerfile.python
    container_name: soundscape-python
    restart: always
    ports:
      - "8000:8000"
    environment:
      PYTHONUNBUFFERED: 1
      API_HOST: 0.0.0.0
      API_PORT: 8000
      LOG_LEVEL: info
      TZ: Asia/Shanghai
    volumes:
      - ../../backend-ai/app:/app/app:ro
      - ../../storage:/app/storage
      - ../../database:/app/database
      - ../../logs/python:/app/logs
    networks:
      - soundscape-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

networks:
  soundscape-network:
    driver: bridge
